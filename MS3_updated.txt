Query 1.
Description: What are the top 10 cheapest, nonbulk return flights between a pair of cities in a given year/quarter?
Contribution: Tianze Chris Yi

WITH rt_fares AS (
SELECT ItinFare, RPCarrier AS outbound_carrier, NULL AS inbound_carrier, is_roundtrip
FROM flight_itinerary
WHERE origin_airport_id IN (SELECT id FROM Airport WHERE city = ${req.param.origin_city})
AND dest_airport_id IN (SELECT id FROM Airport WHERE city = ${req.param.destination_city})
AND is_roundtrip
AND NOT is_bulkfare
AND year = ${req.param.year}
AND quarter = ${req.param.quarter}
),
ow_fares AS (
SELECT ItinFare, RPCarrier, is_roundtrip
FROM flight_itinerary
WHERE origin_airport_id IN (SELECT id FROM Airport WHERE city = ${req.param.origin_city})
AND dest_airport_id IN (SELECT id FROM Airport WHERE city = ${req.param.destination_city})
AND NOT is_roundtrip
AND NOT is_bulkfare
AND year = ${req.param.year}
AND quarter = ${req.param.quarter}
),
ow_rt_fares AS (
SELECT (a.ItinFare + b.ItinFare) AS ItinFare, a.RPCarrier AS outbound_carrier, b.RPCarrier AS inbound_carrier, a.is_roundtrip
FROM flight_itinerary a, ow_fares b
WHERE dest_airport_id IN (SELECT id FROM Airport WHERE city = ${req.param.origin_city})
AND origin_airport_id IN (SELECT id FROM Airport WHERE city = ${req.param.destination_city})
AND NOT is_roundtrip
AND NOT is_bulkfare
AND year = ${req.param.year}
AND quarter = ${req.param.quarter}
),
all_fares AS (
SELECT *
FROM rt_fares
UNION
SELECT *
FROM ow_rt_fares
)
SELECT *
FROM all_fares
ORDER BY ItinFare
LIMIT 10;

------------------------------------------------------

Query 2.
Description: What are the top 10 cheapest destinations (cities) via flights from a given city in a given year/quarter?
Contribution: Tianze Chris Yi

SELECT * 
FROM (SELECT c_orig.city, f.year, f.quarter, c_dest.city AS destination_city, AVG(f.itin_fare) AS avg_fare_price
FROM flight_itinerary f 
JOIN airport a_orig 
	ON f.origin_airport_id = a_orig.id 
JOIN airport a_dest 
	ON f.dest_airport_id = a_dest.id 
JOIN citycode c_orig 
	ON a_orig.city = c_orig.code 
JOIN citycode c_dest 
	ON a_dest.city = c_dest.code
GROUP BY c_orig.city, f.year, f.quarter, c_dest.city
HAVING c_orig.city = ${req.param.origin_city} AND year = ${req.param.year} AND quarter = ${req.param.quarter}
ORDER BY AVG(f.itin_fare))
WHERE ROWNUM <= 10;
------------------------------------------------------

Query 3.
Description: Top 10 cheapest listings in a city given checkin/out dates and accomodation type
Contribution: Tianze Chris Yi

WITH nightly_rate AS (
SELECT a.id, a.name, a.host_name, a.photo_url, b.date, b.price, b.is_available
FROM Listing a
JOIN Availability b
ON a.id = b.listing_id
WHERE (${req.param.checkout_date}- ${${req.param.checkin_date}) >= b.min_num_nights
AND (${req.param.checkout_date}-${req.param.checkin_date}) <= b.max_num_nights
AND b.date >= ${req.param.checkin_date}
AND b.date <= ${req.param.checkout_date}
AND a.city = ${req.param.dest_city}
AND a.accom_type = ${req.param.accom_type}
),
available_nightly_rate AS (
SELECT *
FROM nightly_rate
WHERE a.id NOT IN (SELECT id FROM nightly_rate WHERE NOT is_available)
)
SELECT id, name, host_name, photo_url, SUM(price) AS total_price
FROM available_nightly_rate
GROUP BY 1,2,3,4
ORDER BY total_price
LIMIT 10;

------------------------------------------------------

Query 4.
Based on origin, destination, quarter, year, airplane budget and hotel budget range what are the cheapest recommendations?
Contribution: Wan Ting Huang

WITH a AS (SELECT is_available, listing_id, max_num_nights, min_num_nights, price, TO_DATE(availability_date,'YYYY-MM-DD') AS availability_date
FROM availability
),
filtered_listings AS (SELECT listing_id, name, availability_date, city AS destination_city, 
accom_type, photo_url, price, max_num_nights, min_num_nights 
FROM a
JOIN listing l 
    ON a.listing_id  = l.id
WHERE TO_CHAR(availability_date, 'Q') = ${req.param.quarter} AND 
EXTRACT(YEAR FROM availability_date) = ${req.param.year} AND
city = ${req.param.dest_city} AND 
price BETWEEN ${req.param.min_hotel_budget} AND ${req.param.max_hotel_budget}
),
filtered_flights AS (
SELECT itinerary_id, itin_fare, RPCarrier, quarter, c_orig.city AS origin_city, 
    c_dest.city AS destination_city, origin_airport_id, dest_airport_id
FROM flight_itinerary f
JOIN airport ai_orig  
	ON ai_orig.id = f.origin_airport_id 
JOIN airport ai_dest
    ON ai_dest.id = f.dest_airport_id
JOIN citycode c_orig
    ON ai_orig.city = c_orig.code
JOIN citycode c_dest
    ON ai_dest.	city = c_dest.code
WHERE c_orig.city = ${req.param.origin_city} AND 
      c_dest.city = ${req.param.dest_city} AND
	  f.quarter = ${req.param.quarter} AND 
	  f.is_bulkfare = 0 AND
	  f.year = 2019 AND
	  f.itin_fare BETWEEN ${req.param.min_flight_budget} AND ${req.param.max_flight_budget}
)
SELECT ff.origin_city, ff.origin_airport_id, ff.dest_airport_id, ff.RPCarrier, ff.itin_fare AS flight_fare,
fl.destination_city, fl.accom_type, fl.photo_url, fl.price AS listing_price, fl.max_num_nights, fl.min_num_nights, ff.itin_fare + fl.price AS total_fare 
FROM filtered_listings fl
JOIN filtered_flights ff
    ON ff.destination_city = fl.destination_city
ORDER BY ff.itin_fare + fl.price;

------------------------------------------------------
Query 5.

Show average cheapest city to get an accom_type for a specific range of start dates and number of nights 
Contribution: Wan Ting Huang
 

WITH a AS (SELECT is_available, listing_id, max_num_nights, min_num_nights, price, TO_DATE(availability_date,'YYYY-MM-DD') AS availability_date
FROM availability
),
t AS (SELECT * 
FROM listing l 
JOIN a 
    ON l.id = a.listing_id 
WHERE a.availability_date BETWEEN TO_DATE(${req.param.earliest_date}, 'YYYY-MM-DD') AND TO_DATE(${req.param.latest_date}, 'YYYY-MM-DD') AND 
      ${req.param.num_nights} BETWEEN min_num_nights AND max_num_nights AND 
      a.is_available ='t'
),
h AS (SELECT city, accom_type, AVG(price) AS average_price_per_day 
FROM t
GROUP BY city, accom_type
)
SELECT city, average_price_per_day
FROM h
WHERE accom_type = ${req.param.accomodation_type}
ORDER BY average_price_per_day;


------------------------------------------------------
Query 6.

Best hotels in a city for price for short, medium, and long term stay
Contribution: Wan Ting Huang

WITH length_labeled AS (SELECT l.id, l.name, l.photo_url, l.host_name, l.neighborhood, l.accom_type, l.city, 
       a.availability_date, a.price, a.max_num_nights, a.min_num_nights,
       CASE WHEN a.min_num_nights <= 2 THEN 'short'
	        WHEN a.max_num_nights >= 30 THEN  'long'
	        ELSE 'medium' END AS stay_length
FROM listing l 
JOIN availability a  
	ON l.id = a.listing_id
WHERE is_available = 't')
SELECT *
FROM length_labeled 
WHERE stay_length = 'long' AND
	  city = 'San Francisco, CA (Metropolitan Area)'
ORDER BY price;
------------------------------------------------------

Other query suggestions:
Flexible date search for flight and airbnb (+/- 3 days)
Joining flight and airbnb by year/quarter and city: query 4


------------------------------------------------------

AWS RDS Credentials: (Worthan)
